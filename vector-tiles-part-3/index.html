<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Simple Hexagon Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.54.0/mapbox-gl.js'></script>
    <script src="hexagons.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.54.0/mapbox-gl.css' rel='stylesheet' />
    <style>

        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>


</head>
<body>

    <div id='map'></div>

    <script>
        var coordinates = document.getElementById('coordinates');

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'style.json',
            center: [0, 42],
            maxZoom: 5.9,
            minZoom: 3.0,
            zoom: 4
        });

        var initialCoordinate = [-9.0252685546875, 38.708074666852596];

        var el = document.createElement('div');
        el.className = 'marker';

        setHelicopter(el, false);

        map.on('load', function () {

            var marker = new mapboxgl.Marker(el)
                .setLngLat(initialCoordinate)
                .setDraggable(true)
                .addTo(map);

            marker.on('dragend', function (e) {

                var coordinate = e.target.getLngLat();

                var point = map.project(coordinate);

                var features = map.queryRenderedFeatures(point, { layers: ['hexagons'] });

                if (features.length > 0) {

                    var u = features[0].properties["U"];
                    var v = features[0].properties["V"];

                    var hexagon = new HexDefinition(500);

                    var centerPoint = hexagon.getCenterPointXY(u, v);

                    var centerCoordinate = hexagon.pixelXYToLatLong(centerPoint.x, centerPoint.y, 10);

                    marker.setLngLat([centerCoordinate.longitude, centerCoordinate.latitude]);
                }
            });
        });

        map.on('zoom', function () {
            if (map.getZoom() < 4.7) {
                setHelicopter(el, false);
            } else {
                setHelicopter(el, true);
            }
        });

        function setHelicopter(element, isNear) {
            if (isNear) {

                el.style.backgroundImage = 'url(heli.png)';
                el.style.width = '48px';
                el.style.height = '48px';
            }
            else {

                element.style.backgroundImage = 'url(heli-smaller.png)';
                element.style.width = '18px';
                element.style.height = '18px';
            }
        }

    </script>

</body>
</html>